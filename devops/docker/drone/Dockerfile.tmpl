FROM alpine:3.11.5
RUN apk update && apk upgrade && apk add bash jq curl

RUN mkdir /app
WORKDIR /app
COPY drone_workdir/bin/drone-agent .
COPY drone_workdir/bin/drone-controller .
COPY drone_workdir/bin/drone-server .

ENV DRONE_GITEA_CLIENT_SECRET_VAULT ${DRONE_GITEA_CLIENT_SECRET_VAULT}
ENV DRONE_GITEA_SERVER ${GITEA_PROTOCOL}://${GITEA_HOST}:${GITEA_PORT}

ENV DRONE_DATABASE_DRIVER postgres
ENV DRONE_DATABASE_DATASOURCE postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@${POSTGRES_HOST}:${POSTGRES_PORT}/${DRONE_DATABASE}?sslmode=disable&timezone=UTC
ENV DRONE_DATABASE_SECRET ${DRONE_DATABASE_SECRET}

ENV DRONE_RPC_SECRET ${DRONE_RPC_SECRET}
ENV DRONE_SERVER_PROTO ${DRONE_SERVER_PROTO}
ENV DRONE_SERVER_HOST "${DRONE_SERVER_HOST}:${DRONE_SERVER_PORT}"
ENV DRONE_SERVER_PORT ":${DRONE_SERVER_PORT}"
ENV DRONE_USER_CREATE username:grchive-gitea-admin,machine:false,admin:true,token:${DRONE_TOKEN}

ENV VAULT_HOST ${VAULT_HOST}
ENV VAULT_PORT ${VAULT_PORT}
ENV VAULT_USER ${VAULT_USER}
ENV VAULT_PASSWORD ${VAULT_PASSWORD}

COPY get_vault_secret_http.sh .
COPY run.sh .
ENTRYPOINT exec /app/run.sh
